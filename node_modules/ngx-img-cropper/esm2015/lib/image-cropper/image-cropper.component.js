/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ViewChild, ElementRef, Input, Output, EventEmitter, Renderer2 } from '@angular/core';
import { CropperSettings } from './cropper-settings';
import { ImageCropper } from './imageCropper';
import { CropPosition } from './model/cropPosition';
import { Exif } from './exif';
export class ImageCropperComponent {
    /**
     * @param {?} renderer
     */
    constructor(renderer) {
        this.cropPositionChange = new EventEmitter();
        this.exif = new Exif();
        // tslint:disable-next-line:no-output-on-prefix
        this.onCrop = new EventEmitter();
        this.imageSet = new EventEmitter();
        this.renderer = renderer;
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        /** @type {?} */
        const canvas = this.cropcanvas.nativeElement;
        if (!this.settings) {
            this.settings = new CropperSettings();
        }
        if (this.settings.cropperClass) {
            this.renderer.setAttribute(canvas, 'class', this.settings.cropperClass);
        }
        if (!this.settings.dynamicSizing) {
            this.renderer.setAttribute(canvas, 'width', this.settings.canvasWidth.toString());
            this.renderer.setAttribute(canvas, 'height', this.settings.canvasHeight.toString());
        }
        else {
            this.windowListener = this.resize.bind(this);
            window.addEventListener('resize', this.windowListener);
        }
        if (!this.cropper) {
            this.cropper = new ImageCropper(this.settings);
        }
        this.cropper.prepare(canvas);
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (this.isCropPositionChanged(changes)) {
            this.cropper.updateCropPosition(this.cropPosition.toBounds());
            if (this.cropper.isImageSet()) {
                /** @type {?} */
                const bounds = this.cropper.getCropBounds();
                this.image.image = this.cropper.getCroppedImageHelper().src;
                this.onCrop.emit(bounds);
            }
            this.updateCropBounds();
        }
        if (changes.inputImage) {
            this.setImage(changes.inputImage.currentValue);
        }
        if (changes.settings && this.cropper) {
            this.cropper.updateSettings(this.settings);
            if (this.cropper.isImageSet()) {
                this.image.image = this.cropper.getCroppedImageHelper().src;
                this.onCrop.emit(this.cropper.getCropBounds());
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.settings.dynamicSizing && this.windowListener) {
            window.removeEventListener('resize', this.windowListener);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onTouchMove(event) {
        this.cropper.onTouchMove(event);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onTouchStart(event) {
        this.cropper.onTouchStart(event);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onTouchEnd(event) {
        this.cropper.onTouchEnd(event);
        if (this.cropper.isImageSet()) {
            this.image.image = this.cropper.getCroppedImageHelper().src;
            this.onCrop.emit(this.cropper.getCropBounds());
            this.updateCropBounds();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onMouseDown(event) {
        this.cropper.onMouseDown(event);
        // if (!this.cropper.isImageSet() && !this.settings.noFileInput) {
        //   // load img
        //   this.fileInput.nativeElement.click();
        // }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onMouseUp(event) {
        if (this.cropper.isImageSet()) {
            this.cropper.onMouseUp(event);
            this.image.image = this.cropper.getCroppedImageHelper().src;
            this.onCrop.emit(this.cropper.getCropBounds());
            this.updateCropBounds();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onMouseMove(event) {
        this.cropper.onMouseMove(event);
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    fileChangeListener($event) {
        if ($event.target.files.length === 0) {
            return;
        }
        /** @type {?} */
        const file = $event.target.files[0];
        if (this.settings.allowedFilesRegex.test(file.name)) {
            /** @type {?} */
            const image = new Image();
            /** @type {?} */
            const fileReader = new FileReader();
            fileReader.addEventListener('loadend', (/**
             * @param {?} loadEvent
             * @return {?}
             */
            (loadEvent) => {
                image.addEventListener('load', (/**
                 * @return {?}
                 */
                () => {
                    this.setImage(image);
                }));
                image.src = loadEvent.target.result;
            }));
            fileReader.readAsDataURL(file);
        }
    }
    /**
     * @private
     * @return {?}
     */
    resize() {
        /** @type {?} */
        const canvas = this.cropcanvas.nativeElement;
        this.settings.canvasWidth = canvas.offsetWidth;
        this.settings.canvasHeight = canvas.offsetHeight;
        this.cropper.resizeCanvas(canvas.offsetWidth, canvas.offsetHeight, true);
    }
    /**
     * @return {?}
     */
    reset() {
        this.cropper.reset();
        this.renderer.setAttribute(this.cropcanvas.nativeElement, 'class', this.settings.cropperClass);
        this.image.image = this.cropper.getCroppedImageHelper().src;
    }
    /**
     * @param {?} image
     * @param {?=} newBounds
     * @return {?}
     */
    setImage(image, newBounds = null) {
        this.imageSet.emit(true);
        this.renderer.setAttribute(this.cropcanvas.nativeElement, 'class', `${this.settings.cropperClass} ${this.settings.croppingClass}`);
        this.raf = window.requestAnimationFrame((/**
         * @return {?}
         */
        () => {
            if (this.raf) {
                window.cancelAnimationFrame(this.raf);
            }
            if (image.naturalHeight > 0 && image.naturalWidth > 0) {
                image.height = image.naturalHeight;
                image.width = image.naturalWidth;
                window.cancelAnimationFrame(this.raf);
                this.getOrientedImage(image, (/**
                 * @param {?} img
                 * @return {?}
                 */
                (img) => {
                    if (this.settings.dynamicSizing) {
                        /** @type {?} */
                        const canvas = this.cropcanvas.nativeElement;
                        this.settings.canvasWidth = canvas.offsetWidth;
                        this.settings.canvasHeight = canvas.offsetHeight;
                        this.cropper.resizeCanvas(canvas.offsetWidth, canvas.offsetHeight, false);
                    }
                    this.cropper.setImage(img);
                    if (this.cropPosition && this.cropPosition.isInitialized()) {
                        this.cropper.updateCropPosition(this.cropPosition.toBounds());
                    }
                    this.image.original = img;
                    /** @type {?} */
                    let bounds = this.cropper.getCropBounds();
                    this.image.image = this.cropper.getCroppedImageHelper().src;
                    if (!this.image) {
                        this.image = image;
                    }
                    if (newBounds != null) {
                        bounds = newBounds;
                        this.cropper.setBounds(bounds);
                        this.cropper.updateCropPosition(bounds);
                    }
                    this.onCrop.emit(bounds);
                }));
            }
        }));
    }
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    isCropPositionChanged(changes) {
        if (this.cropper &&
            changes.cropPosition &&
            this.isCropPositionUpdateNeeded) {
            return true;
        }
        else {
            this.isCropPositionUpdateNeeded = true;
            return false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    updateCropBounds() {
        /** @type {?} */
        const cropBound = this.cropper.getCropBounds();
        this.cropPositionChange.emit(new CropPosition(cropBound.left, cropBound.top, cropBound.width, cropBound.height));
        this.isCropPositionUpdateNeeded = false;
    }
    /**
     * @private
     * @param {?} image
     * @param {?} callback
     * @return {?}
     */
    getOrientedImage(image, callback) {
        /** @type {?} */
        let img;
        this.exif.getData(image, (/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const orientation = this.exif.getTag(image, 'Orientation');
            if ([3, 6, 8].indexOf(orientation) > -1) {
                /** @type {?} */
                const canvas = document.createElement('canvas');
                /** @type {?} */
                const ctx = (/** @type {?} */ (canvas.getContext('2d')));
                /** @type {?} */
                let cw = image.width;
                /** @type {?} */
                let ch = image.height;
                /** @type {?} */
                let cx = 0;
                /** @type {?} */
                let cy = 0;
                /** @type {?} */
                let deg = 0;
                switch (orientation) {
                    case 3:
                        cx = -image.width;
                        cy = -image.height;
                        deg = 180;
                        break;
                    case 6:
                        cw = image.height;
                        ch = image.width;
                        cy = -image.height;
                        deg = 90;
                        break;
                    case 8:
                        cw = image.height;
                        ch = image.width;
                        cx = -image.width;
                        deg = 270;
                        break;
                    default:
                        break;
                }
                canvas.width = cw;
                canvas.height = ch;
                ctx.rotate((deg * Math.PI) / 180);
                ctx.drawImage(image, cx, cy);
                img = document.createElement('img');
                img.width = cw;
                img.height = ch;
                img.addEventListener('load', (/**
                 * @return {?}
                 */
                () => {
                    callback(img);
                }));
                img.src = canvas.toDataURL('image/png');
            }
            else {
                img = image;
                callback(img);
            }
        }));
    }
}
ImageCropperComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'img-cropper',
                template: "<span class=\"ng2-imgcrop\">\n  <input\n    *ngIf=\"!settings.noFileInput\"\n    #fileInput\n    type=\"file\"\n    accept=\"image/*\"\n    (change)=\"fileChangeListener($event)\"\n  />\n  <canvas\n    #cropcanvas\n    (mousedown)=\"onMouseDown($event)\"\n    (mouseup)=\"onMouseUp($event)\"\n    (mousemove)=\"onMouseMove($event)\"\n    (mouseleave)=\"onMouseUp($event)\"\n    (touchmove)=\"onTouchMove($event)\"\n    (touchend)=\"onTouchEnd($event)\"\n    (touchstart)=\"onTouchStart($event)\"\n  >\n  </canvas>\n</span>\n"
            }] }
];
/** @nocollapse */
ImageCropperComponent.ctorParameters = () => [
    { type: Renderer2 }
];
ImageCropperComponent.propDecorators = {
    cropcanvas: [{ type: ViewChild, args: ['cropcanvas', { static: true },] }],
    fileInput: [{ type: ViewChild, args: ['fileInput', { static: false },] }],
    settings: [{ type: Input }],
    image: [{ type: Input }],
    inputImage: [{ type: Input }],
    cropper: [{ type: Input }],
    cropPosition: [{ type: Input }],
    cropPositionChange: [{ type: Output }],
    onCrop: [{ type: Output }],
    imageSet: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    ImageCropperComponent.prototype.cropcanvas;
    /** @type {?} */
    ImageCropperComponent.prototype.fileInput;
    /** @type {?} */
    ImageCropperComponent.prototype.settings;
    /** @type {?} */
    ImageCropperComponent.prototype.image;
    /** @type {?} */
    ImageCropperComponent.prototype.inputImage;
    /** @type {?} */
    ImageCropperComponent.prototype.cropper;
    /** @type {?} */
    ImageCropperComponent.prototype.cropPosition;
    /** @type {?} */
    ImageCropperComponent.prototype.cropPositionChange;
    /**
     * @type {?}
     * @private
     */
    ImageCropperComponent.prototype.exif;
    /** @type {?} */
    ImageCropperComponent.prototype.onCrop;
    /** @type {?} */
    ImageCropperComponent.prototype.imageSet;
    /** @type {?} */
    ImageCropperComponent.prototype.croppedWidth;
    /** @type {?} */
    ImageCropperComponent.prototype.croppedHeight;
    /** @type {?} */
    ImageCropperComponent.prototype.intervalRef;
    /** @type {?} */
    ImageCropperComponent.prototype.raf;
    /** @type {?} */
    ImageCropperComponent.prototype.renderer;
    /** @type {?} */
    ImageCropperComponent.prototype.windowListener;
    /**
     * @type {?}
     * @private
     */
    ImageCropperComponent.prototype.isCropPositionUpdateNeeded;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY3JvcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtaW1nLWNyb3BwZXIvIiwic291cmNlcyI6WyJsaWIvaW1hZ2UtY3JvcHBlci9pbWFnZS1jcm9wcGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFJVCxTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFNBQVMsRUFFVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBTzlCLE1BQU0sT0FBTyxxQkFBcUI7Ozs7SUErQmhDLFlBQVksUUFBbUI7UUFuQnhCLHVCQUFrQixHQUErQixJQUFJLFlBQVksRUFFckUsQ0FBQztRQUVJLFNBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDOztRQUdULFdBQU0sR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN0RCxhQUFRLEdBQTBCLElBQUksWUFBWSxFQUFXLENBQUM7UUFZdEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDM0IsQ0FBQzs7OztJQUVNLGVBQWU7O2NBQ2QsTUFBTSxHQUFzQixJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWE7UUFFL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRTtZQUM5QixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FB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RSx5Q0FBd0U7O0lBRXhFLDZDQUE0Qjs7SUFDNUIsOENBQTZCOztJQUM3Qiw0Q0FBMkI7O0lBQzNCLG9DQUFtQjs7SUFDbkIseUNBQTJCOztJQUMzQiwrQ0FBMkM7Ozs7O0lBRTNDLDJEQUE0QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBWaWV3Q2hpbGQsXHJcbiAgRWxlbWVudFJlZixcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIFJlbmRlcmVyMixcclxuICBTaW1wbGVDaGFuZ2VzXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENyb3BwZXJTZXR0aW5ncyB9IGZyb20gJy4vY3JvcHBlci1zZXR0aW5ncyc7XHJcbmltcG9ydCB7IEltYWdlQ3JvcHBlciB9IGZyb20gJy4vaW1hZ2VDcm9wcGVyJztcclxuaW1wb3J0IHsgQ3JvcFBvc2l0aW9uIH0gZnJvbSAnLi9tb2RlbC9jcm9wUG9zaXRpb24nO1xyXG5pbXBvcnQgeyBCb3VuZHMgfSBmcm9tICcuL21vZGVsL2JvdW5kcyc7XHJcbmltcG9ydCB7IEV4aWYgfSBmcm9tICcuL2V4aWYnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmNvbXBvbmVudC1zZWxlY3RvclxyXG4gIHNlbGVjdG9yOiAnaW1nLWNyb3BwZXInLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9pbWFnZS1jcm9wcGVyLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgSW1hZ2VDcm9wcGVyQ29tcG9uZW50XHJcbiAgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgQFZpZXdDaGlsZCgnY3JvcGNhbnZhcycsIHsgc3RhdGljOiB0cnVlIH0pXHJcbiAgY3JvcGNhbnZhczogRWxlbWVudFJlZjtcclxuICBAVmlld0NoaWxkKCdmaWxlSW5wdXQnLCB7IHN0YXRpYzogZmFsc2UgfSkgZmlsZUlucHV0OiBFbGVtZW50UmVmO1xyXG5cclxuICBASW5wdXQoKSBwdWJsaWMgc2V0dGluZ3M6IENyb3BwZXJTZXR0aW5ncztcclxuICBASW5wdXQoKSBwdWJsaWMgaW1hZ2U6IGFueTtcclxuICBASW5wdXQoKSBwdWJsaWMgaW5wdXRJbWFnZTogYW55O1xyXG4gIEBJbnB1dCgpIHB1YmxpYyBjcm9wcGVyOiBJbWFnZUNyb3BwZXI7XHJcbiAgQElucHV0KCkgcHVibGljIGNyb3BQb3NpdGlvbjogQ3JvcFBvc2l0aW9uO1xyXG4gIEBPdXRwdXQoKVxyXG4gIHB1YmxpYyBjcm9wUG9zaXRpb25DaGFuZ2U6IEV2ZW50RW1pdHRlcjxDcm9wUG9zaXRpb24+ID0gbmV3IEV2ZW50RW1pdHRlcjxcclxuICAgIENyb3BQb3NpdGlvblxyXG4gID4oKTtcclxuXHJcbiAgcHJpdmF0ZSBleGlmID0gbmV3IEV4aWYoKTtcclxuXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW91dHB1dC1vbi1wcmVmaXhcclxuICBAT3V0cHV0KCkgcHVibGljIG9uQ3JvcDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgQE91dHB1dCgpIGltYWdlU2V0OiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XHJcblxyXG4gIHB1YmxpYyBjcm9wcGVkV2lkdGg6IG51bWJlcjtcclxuICBwdWJsaWMgY3JvcHBlZEhlaWdodDogbnVtYmVyO1xyXG4gIHB1YmxpYyBpbnRlcnZhbFJlZjogbnVtYmVyO1xyXG4gIHB1YmxpYyByYWY6IG51bWJlcjtcclxuICBwdWJsaWMgcmVuZGVyZXI6IFJlbmRlcmVyMjtcclxuICBwdWJsaWMgd2luZG93TGlzdGVuZXI6IEV2ZW50TGlzdGVuZXJPYmplY3Q7XHJcblxyXG4gIHByaXZhdGUgaXNDcm9wUG9zaXRpb25VcGRhdGVOZWVkZWQ6IGJvb2xlYW47XHJcblxyXG4gIGNvbnN0cnVjdG9yKHJlbmRlcmVyOiBSZW5kZXJlcjIpIHtcclxuICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gdGhpcy5jcm9wY2FudmFzLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgaWYgKCF0aGlzLnNldHRpbmdzKSB7XHJcbiAgICAgIHRoaXMuc2V0dGluZ3MgPSBuZXcgQ3JvcHBlclNldHRpbmdzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuc2V0dGluZ3MuY3JvcHBlckNsYXNzKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGNhbnZhcywgJ2NsYXNzJywgdGhpcy5zZXR0aW5ncy5jcm9wcGVyQ2xhc3MpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5zZXR0aW5ncy5keW5hbWljU2l6aW5nKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKFxyXG4gICAgICAgIGNhbnZhcyxcclxuICAgICAgICAnd2lkdGgnLFxyXG4gICAgICAgIHRoaXMuc2V0dGluZ3MuY2FudmFzV2lkdGgudG9TdHJpbmcoKVxyXG4gICAgICApO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShcclxuICAgICAgICBjYW52YXMsXHJcbiAgICAgICAgJ2hlaWdodCcsXHJcbiAgICAgICAgdGhpcy5zZXR0aW5ncy5jYW52YXNIZWlnaHQudG9TdHJpbmcoKVxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy53aW5kb3dMaXN0ZW5lciA9IHRoaXMucmVzaXplLmJpbmQodGhpcyk7XHJcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLndpbmRvd0xpc3RlbmVyKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRoaXMuY3JvcHBlcikge1xyXG4gICAgICB0aGlzLmNyb3BwZXIgPSBuZXcgSW1hZ2VDcm9wcGVyKHRoaXMuc2V0dGluZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY3JvcHBlci5wcmVwYXJlKGNhbnZhcyk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaXNDcm9wUG9zaXRpb25DaGFuZ2VkKGNoYW5nZXMpKSB7XHJcbiAgICAgIHRoaXMuY3JvcHBlci51cGRhdGVDcm9wUG9zaXRpb24odGhpcy5jcm9wUG9zaXRpb24udG9Cb3VuZHMoKSk7XHJcbiAgICAgIGlmICh0aGlzLmNyb3BwZXIuaXNJbWFnZVNldCgpKSB7XHJcbiAgICAgICAgY29uc3QgYm91bmRzID0gdGhpcy5jcm9wcGVyLmdldENyb3BCb3VuZHMoKTtcclxuICAgICAgICB0aGlzLmltYWdlLmltYWdlID0gdGhpcy5jcm9wcGVyLmdldENyb3BwZWRJbWFnZUhlbHBlcigpLnNyYztcclxuICAgICAgICB0aGlzLm9uQ3JvcC5lbWl0KGJvdW5kcyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVDcm9wQm91bmRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNoYW5nZXMuaW5wdXRJbWFnZSkge1xyXG4gICAgICB0aGlzLnNldEltYWdlKGNoYW5nZXMuaW5wdXRJbWFnZS5jdXJyZW50VmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjaGFuZ2VzLnNldHRpbmdzICYmIHRoaXMuY3JvcHBlcikge1xyXG4gICAgICB0aGlzLmNyb3BwZXIudXBkYXRlU2V0dGluZ3ModGhpcy5zZXR0aW5ncyk7XHJcbiAgICAgIGlmICh0aGlzLmNyb3BwZXIuaXNJbWFnZVNldCgpKSB7XHJcbiAgICAgICAgdGhpcy5pbWFnZS5pbWFnZSA9IHRoaXMuY3JvcHBlci5nZXRDcm9wcGVkSW1hZ2VIZWxwZXIoKS5zcmM7XHJcbiAgICAgICAgdGhpcy5vbkNyb3AuZW1pdCh0aGlzLmNyb3BwZXIuZ2V0Q3JvcEJvdW5kcygpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nT25EZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMuc2V0dGluZ3MuZHluYW1pY1NpemluZyAmJiB0aGlzLndpbmRvd0xpc3RlbmVyKSB7XHJcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLndpbmRvd0xpc3RlbmVyKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBvblRvdWNoTW92ZShldmVudDogVG91Y2hFdmVudCk6IHZvaWQge1xyXG4gICAgdGhpcy5jcm9wcGVyLm9uVG91Y2hNb3ZlKGV2ZW50KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvblRvdWNoU3RhcnQoZXZlbnQ6IFRvdWNoRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuY3JvcHBlci5vblRvdWNoU3RhcnQoZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uVG91Y2hFbmQoZXZlbnQ6IFRvdWNoRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuY3JvcHBlci5vblRvdWNoRW5kKGV2ZW50KTtcclxuICAgIGlmICh0aGlzLmNyb3BwZXIuaXNJbWFnZVNldCgpKSB7XHJcbiAgICAgIHRoaXMuaW1hZ2UuaW1hZ2UgPSB0aGlzLmNyb3BwZXIuZ2V0Q3JvcHBlZEltYWdlSGVscGVyKCkuc3JjO1xyXG4gICAgICB0aGlzLm9uQ3JvcC5lbWl0KHRoaXMuY3JvcHBlci5nZXRDcm9wQm91bmRzKCkpO1xyXG4gICAgICB0aGlzLnVwZGF0ZUNyb3BCb3VuZHMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbk1vdXNlRG93bihldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgdGhpcy5jcm9wcGVyLm9uTW91c2VEb3duKGV2ZW50KTtcclxuICAgIC8vIGlmICghdGhpcy5jcm9wcGVyLmlzSW1hZ2VTZXQoKSAmJiAhdGhpcy5zZXR0aW5ncy5ub0ZpbGVJbnB1dCkge1xyXG4gICAgLy8gICAvLyBsb2FkIGltZ1xyXG4gICAgLy8gICB0aGlzLmZpbGVJbnB1dC5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAvLyB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Nb3VzZVVwKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5jcm9wcGVyLmlzSW1hZ2VTZXQoKSkge1xyXG4gICAgICB0aGlzLmNyb3BwZXIub25Nb3VzZVVwKGV2ZW50KTtcclxuICAgICAgdGhpcy5pbWFnZS5pbWFnZSA9IHRoaXMuY3JvcHBlci5nZXRDcm9wcGVkSW1hZ2VIZWxwZXIoKS5zcmM7XHJcbiAgICAgIHRoaXMub25Dcm9wLmVtaXQodGhpcy5jcm9wcGVyLmdldENyb3BCb3VuZHMoKSk7XHJcbiAgICAgIHRoaXMudXBkYXRlQ3JvcEJvdW5kcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uTW91c2VNb3ZlKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLmNyb3BwZXIub25Nb3VzZU1vdmUoZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGZpbGVDaGFuZ2VMaXN0ZW5lcigkZXZlbnQ6IGFueSkge1xyXG4gICAgaWYgKCRldmVudC50YXJnZXQuZmlsZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaWxlOiBGaWxlID0gJGV2ZW50LnRhcmdldC5maWxlc1swXTtcclxuICAgIGlmICh0aGlzLnNldHRpbmdzLmFsbG93ZWRGaWxlc1JlZ2V4LnRlc3QoZmlsZS5uYW1lKSkge1xyXG4gICAgICBjb25zdCBpbWFnZTogYW55ID0gbmV3IEltYWdlKCk7XHJcbiAgICAgIGNvbnN0IGZpbGVSZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG5cclxuICAgICAgZmlsZVJlYWRlci5hZGRFdmVudExpc3RlbmVyKCdsb2FkZW5kJywgKGxvYWRFdmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgaW1hZ2UuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc2V0SW1hZ2UoaW1hZ2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGltYWdlLnNyYyA9IGxvYWRFdmVudC50YXJnZXQucmVzdWx0O1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGZpbGVSZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVzaXplKCkge1xyXG4gICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IHRoaXMuY3JvcGNhbnZhcy5uYXRpdmVFbGVtZW50O1xyXG4gICAgdGhpcy5zZXR0aW5ncy5jYW52YXNXaWR0aCA9IGNhbnZhcy5vZmZzZXRXaWR0aDtcclxuICAgIHRoaXMuc2V0dGluZ3MuY2FudmFzSGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodDtcclxuICAgIHRoaXMuY3JvcHBlci5yZXNpemVDYW52YXMoY2FudmFzLm9mZnNldFdpZHRoLCBjYW52YXMub2Zmc2V0SGVpZ2h0LCB0cnVlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMuY3JvcHBlci5yZXNldCgpO1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoXHJcbiAgICAgIHRoaXMuY3JvcGNhbnZhcy5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAnY2xhc3MnLFxyXG4gICAgICB0aGlzLnNldHRpbmdzLmNyb3BwZXJDbGFzc1xyXG4gICAgKTtcclxuICAgIHRoaXMuaW1hZ2UuaW1hZ2UgPSB0aGlzLmNyb3BwZXIuZ2V0Q3JvcHBlZEltYWdlSGVscGVyKCkuc3JjO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldEltYWdlKGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50LCBuZXdCb3VuZHM6IGFueSA9IG51bGwpIHtcclxuICAgIHRoaXMuaW1hZ2VTZXQuZW1pdCh0cnVlKTtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKFxyXG4gICAgICB0aGlzLmNyb3BjYW52YXMubmF0aXZlRWxlbWVudCxcclxuICAgICAgJ2NsYXNzJyxcclxuICAgICAgYCR7dGhpcy5zZXR0aW5ncy5jcm9wcGVyQ2xhc3N9ICR7dGhpcy5zZXR0aW5ncy5jcm9wcGluZ0NsYXNzfWBcclxuICAgICk7XHJcbiAgICB0aGlzLnJhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5yYWYpIHtcclxuICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5yYWYpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChpbWFnZS5uYXR1cmFsSGVpZ2h0ID4gMCAmJiBpbWFnZS5uYXR1cmFsV2lkdGggPiAwKSB7XHJcbiAgICAgICAgaW1hZ2UuaGVpZ2h0ID0gaW1hZ2UubmF0dXJhbEhlaWdodDtcclxuICAgICAgICBpbWFnZS53aWR0aCA9IGltYWdlLm5hdHVyYWxXaWR0aDtcclxuXHJcbiAgICAgICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMucmFmKTtcclxuICAgICAgICB0aGlzLmdldE9yaWVudGVkSW1hZ2UoaW1hZ2UsIChpbWc6IEhUTUxJbWFnZUVsZW1lbnQpID0+IHtcclxuICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLmR5bmFtaWNTaXppbmcpIHtcclxuICAgICAgICAgICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IHRoaXMuY3JvcGNhbnZhcy5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbnZhc1dpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbnZhc0hlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgICAgIHRoaXMuY3JvcHBlci5yZXNpemVDYW52YXMoXHJcbiAgICAgICAgICAgICAgY2FudmFzLm9mZnNldFdpZHRoLFxyXG4gICAgICAgICAgICAgIGNhbnZhcy5vZmZzZXRIZWlnaHQsXHJcbiAgICAgICAgICAgICAgZmFsc2VcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0aGlzLmNyb3BwZXIuc2V0SW1hZ2UoaW1nKTtcclxuICAgICAgICAgIGlmICh0aGlzLmNyb3BQb3NpdGlvbiAmJiB0aGlzLmNyb3BQb3NpdGlvbi5pc0luaXRpYWxpemVkKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jcm9wcGVyLnVwZGF0ZUNyb3BQb3NpdGlvbih0aGlzLmNyb3BQb3NpdGlvbi50b0JvdW5kcygpKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0aGlzLmltYWdlLm9yaWdpbmFsID0gaW1nO1xyXG4gICAgICAgICAgbGV0IGJvdW5kcyA9IHRoaXMuY3JvcHBlci5nZXRDcm9wQm91bmRzKCk7XHJcbiAgICAgICAgICB0aGlzLmltYWdlLmltYWdlID0gdGhpcy5jcm9wcGVyLmdldENyb3BwZWRJbWFnZUhlbHBlcigpLnNyYztcclxuXHJcbiAgICAgICAgICBpZiAoIXRoaXMuaW1hZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5pbWFnZSA9IGltYWdlO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGlmIChuZXdCb3VuZHMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBib3VuZHMgPSBuZXdCb3VuZHM7XHJcbiAgICAgICAgICAgIHRoaXMuY3JvcHBlci5zZXRCb3VuZHMoYm91bmRzKTtcclxuICAgICAgICAgICAgdGhpcy5jcm9wcGVyLnVwZGF0ZUNyb3BQb3NpdGlvbihib3VuZHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdGhpcy5vbkNyb3AuZW1pdChib3VuZHMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNDcm9wUG9zaXRpb25DaGFuZ2VkKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiBib29sZWFuIHtcclxuICAgIGlmIChcclxuICAgICAgdGhpcy5jcm9wcGVyICYmXHJcbiAgICAgIGNoYW5nZXMuY3JvcFBvc2l0aW9uICYmXHJcbiAgICAgIHRoaXMuaXNDcm9wUG9zaXRpb25VcGRhdGVOZWVkZWRcclxuICAgICkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuaXNDcm9wUG9zaXRpb25VcGRhdGVOZWVkZWQgPSB0cnVlO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZUNyb3BCb3VuZHMoKTogdm9pZCB7XHJcbiAgICBjb25zdCBjcm9wQm91bmQ6IEJvdW5kcyA9IHRoaXMuY3JvcHBlci5nZXRDcm9wQm91bmRzKCk7XHJcbiAgICB0aGlzLmNyb3BQb3NpdGlvbkNoYW5nZS5lbWl0KFxyXG4gICAgICBuZXcgQ3JvcFBvc2l0aW9uKFxyXG4gICAgICAgIGNyb3BCb3VuZC5sZWZ0LFxyXG4gICAgICAgIGNyb3BCb3VuZC50b3AsXHJcbiAgICAgICAgY3JvcEJvdW5kLndpZHRoLFxyXG4gICAgICAgIGNyb3BCb3VuZC5oZWlnaHRcclxuICAgICAgKVxyXG4gICAgKTtcclxuICAgIHRoaXMuaXNDcm9wUG9zaXRpb25VcGRhdGVOZWVkZWQgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0T3JpZW50ZWRJbWFnZShcclxuICAgIGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50LFxyXG4gICAgY2FsbGJhY2s6IChpbWc6IEhUTUxJbWFnZUVsZW1lbnQpID0+IHZvaWRcclxuICApIHtcclxuICAgIGxldCBpbWc6IGFueTtcclxuXHJcbiAgICB0aGlzLmV4aWYuZ2V0RGF0YShpbWFnZSwgKCkgPT4ge1xyXG4gICAgICBjb25zdCBvcmllbnRhdGlvbiA9IHRoaXMuZXhpZi5nZXRUYWcoaW1hZ2UsICdPcmllbnRhdGlvbicpO1xyXG5cclxuICAgICAgaWYgKFszLCA2LCA4XS5pbmRleE9mKG9yaWVudGF0aW9uKSA+IC0xKSB7XHJcbiAgICAgICAgY29uc3QgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgICAgIGNvbnN0IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEID0gY2FudmFzLmdldENvbnRleHQoXHJcbiAgICAgICAgICAnMmQnXHJcbiAgICAgICAgKSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XHJcbiAgICAgICAgbGV0IGN3OiBudW1iZXIgPSBpbWFnZS53aWR0aDtcclxuICAgICAgICBsZXQgY2g6IG51bWJlciA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICBsZXQgY3ggPSAwO1xyXG4gICAgICAgIGxldCBjeSA9IDA7XHJcbiAgICAgICAgbGV0IGRlZyA9IDA7XHJcblxyXG4gICAgICAgIHN3aXRjaCAob3JpZW50YXRpb24pIHtcclxuICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgY3ggPSAtaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICAgIGN5ID0gLWltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgZGVnID0gMTgwO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgNjpcclxuICAgICAgICAgICAgY3cgPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgICAgICAgIGNoID0gaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICAgIGN5ID0gLWltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgZGVnID0gOTA7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSA4OlxyXG4gICAgICAgICAgICBjdyA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgY2ggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgY3ggPSAtaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICAgIGRlZyA9IDI3MDtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNhbnZhcy53aWR0aCA9IGN3O1xyXG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjaDtcclxuICAgICAgICBjdHgucm90YXRlKChkZWcgKiBNYXRoLlBJKSAvIDE4MCk7XHJcbiAgICAgICAgY3R4LmRyYXdJbWFnZShpbWFnZSwgY3gsIGN5KTtcclxuICAgICAgICBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcclxuICAgICAgICBpbWcud2lkdGggPSBjdztcclxuICAgICAgICBpbWcuaGVpZ2h0ID0gY2g7XHJcbiAgICAgICAgaW1nLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiB7XHJcbiAgICAgICAgICBjYWxsYmFjayhpbWcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpbWcgPSBpbWFnZTtcclxuICAgICAgICBjYWxsYmFjayhpbWcpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19
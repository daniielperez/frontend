!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("ngx-img-cropper",["exports","@angular/core","@angular/common"],e):e((t=t||self)["ngx-img-cropper"]={},t.ng.core,t.ng.common)}(this,function(t,e,i){"use strict";var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function r(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function n(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}}var s=function(){return function(t){this.lineDash=!1,this.strokeWidth=1,this.strokeColor="rgba(255,255,255,1)",this.fillColor="rgba(255,255,255,1)",this.dragIconStrokeWidth=1,this.dragIconStrokeColor="rgba(0,0,0,1)",this.dragIconFillColor="rgba(255,255,255,1)",this.backgroundFillColor="rgba(0,0,0,0.6)","object"==typeof t&&(this.lineDash=t.lineDash||this.lineDash,this.strokeWidth=t.strokeWidth||this.strokeWidth,this.fillColor=t.fillColor||this.fillColor,this.strokeColor=t.strokeColor||this.strokeColor,this.dragIconStrokeWidth=t.dragIconStrokeWidth||this.dragIconStrokeWidth,this.dragIconStrokeColor=t.dragIconStrokeColor||this.dragIconStrokeColor,this.dragIconFillColor=t.dragIconFillColor||this.dragIconFillColor,this.backgroundFillColor=t.backgroundFillColor||this.backgroundFillColor)}}(),a=function(){function t(t){this.canvasWidth=300,this.canvasHeight=300,this.dynamicSizing=!1,this.width=200,this.height=200,this.minWidth=50,this.minHeight=50,this.minWithRelativeToResolution=!0,this.croppedWidth=100,this.croppedHeight=100,this.cropperDrawSettings=new s,this.touchRadius=20,this.noFileInput=!1,this.markerSizeMultiplier=1,this.centerTouchRadius=20,this.showCenterMarker=!0,this.allowedFilesRegex=/\.(jpe?g|png|gif|bmp)$/i,this.cropOnResize=!0,this.preserveSize=!1,this.compressRatio=1,this._rounded=!1,this._keepAspect=!0,"object"==typeof t&&Object.assign(this,t)}return Object.defineProperty(t.prototype,"rounded",{get:function(){return this._rounded},set:function(t){this._rounded=t,t&&(this._keepAspect=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"keepAspect",{get:function(){return this._keepAspect},set:function(t){this._keepAspect=t,!0===this._rounded&&!1===this._keepAspect&&(console.error("Cannot set keep aspect to false on rounded cropper. Ellipsis not supported"),this._keepAspect=!0)},enumerable:!0,configurable:!0}),t}(),h=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e}(Number),p=function(){function t(){this.debug=!1,this.IptcFieldMap={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"},this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}}}return t.prototype.addEvent=function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)},t.prototype.imageHasData=function(t){return!!t.exifdata},t.prototype.base64ToArrayBuffer=function(t){t=t.replace(/^data:([^;]+);base64,/gim,"");for(var e=atob(t),i=e.length,o=new ArrayBuffer(i),r=new Uint8Array(o),n=0;n<i;n++)r[n]=e.charCodeAt(n);return o},t.prototype.objectURLToBlob=function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(){200!==i.status&&0!==i.status||e(i.response)},i.send()},t.prototype.getImageData=function(t,e){var i=this,o=function(o){var r=i.findEXIFinJPEG(o),n=i.findIPTCinJPEG(o);t.exifdata=r||{},t.iptcdata=n||{},e&&e.call(t)};if("src"in t&&t.src)if(/^data:/i.test(t.src)){var r=this.base64ToArrayBuffer(t.src);o(r)}else if(/^blob:/i.test(t.src)){var n=new FileReader;n.onload=function(t){o(t.target.result)},this.objectURLToBlob(t.src,function(t){n.readAsArrayBuffer(t)})}else{var s=new XMLHttpRequest;s.onload=function(){if(200!==s.status&&0!==s.status)throw new Error("Could not load image");o(s.response)},s.open("GET",t.src,!0),s.responseType="arraybuffer",s.send(null)}else if(FileReader&&(t instanceof Blob||t instanceof File)){var a=new FileReader;a.onload=function(t){i.log("Got file of length "+t.target.result.byteLength),o(t.target.result)},a.readAsArrayBuffer(t)}},t.prototype.findEXIFinJPEG=function(t){var e=new DataView(t);if(this.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return this.log("Not a valid JPEG"),!1;for(var i,o=2,r=t.byteLength;o<r;){if(255!==e.getUint8(o))return this.log("Not a valid marker at offset "+o+", found: "+e.getUint8(o)),!1;if(i=e.getUint8(o+1),this.log(i),225===i)return this.log("Found 0xFFE1 marker"),this.readEXIFData(e,o+4);o+=2+e.getUint16(o+2)}},t.prototype.findIPTCinJPEG=function(t){var e=new DataView(t);if(this.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return this.log("Not a valid JPEG"),!1;for(var i,o,r=2,n=t.byteLength;r<n;){if(o=r,56===(i=e).getUint8(o)&&66===i.getUint8(o+1)&&73===i.getUint8(o+2)&&77===i.getUint8(o+3)&&4===i.getUint8(o+4)&&4===i.getUint8(o+5)){var s=e.getUint8(r+7);s%2!=0&&(s+=1),0===s&&(s=4);var a=r+8+s,h=e.getUint16(r+6+s);return this.readIPTCData(t,a,h)}r++}},t.prototype.readIPTCData=function(t,e,i){for(var o,r,n,s,a=new DataView(t),h={},p=e;p<e+i;)28===a.getUint8(p)&&2===a.getUint8(p+1)&&(s=a.getUint8(p+2))in this.IptcFieldMap&&(n=a.getInt16(p+3),r=this.IptcFieldMap[s],o=this.getStringFromDB(a,p+5,n),h.hasOwnProperty(r)?h[r]instanceof Array?h[r].push(o):h[r]=[h[r],o]:h[r]=o),p++;return h},t.prototype.readTags=function(t,e,i,o,r){for(var n,s,a=t.getUint16(i,!r),h={},p=0;p<a;p++)n=i+12*p+2,(s=o[t.getUint16(n,!r)])||this.log("Unknown tag: "+t.getUint16(n,!r)),h[s]=this.readTagValue(t,n,e,i,r);return h},t.prototype.readTagValue=function(t,e,i,o,r){var n,s,a,p,c,g,u=t.getUint16(e+2,!r),l=t.getUint32(e+4,!r),d=t.getUint32(e+8,!r)+i;switch(u){case 1:case 7:if(1===l)return t.getUint8(e+8,!r);for(n=l>4?d:e+8,s=[],p=0;p<l;p++)s[p]=t.getUint8(n+p);return s;case 2:return n=l>4?d:e+8,this.getStringFromDB(t,n,l-1);case 3:if(1===l)return t.getUint16(e+8,!r);for(n=l>2?d:e+8,s=[],p=0;p<l;p++)s[p]=t.getUint16(n+2*p,!r);return s;case 4:if(1===l)return t.getUint32(e+8,!r);for(s=[],p=0;p<l;p++)s[p]=t.getUint32(d+4*p,!r);return s;case 5:if(1===l)return c=t.getUint32(d,!r),g=t.getUint32(d+4,!r),(a=new h(c/g)).numerator=c,a.denominator=g,a;for(s=[],p=0;p<l;p++)c=t.getUint32(d+8*p,!r),g=t.getUint32(d+4+8*p,!r),s[p]=new h(c/g),s[p].numerator=c,s[p].denominator=g;return s;case 9:if(1===l)return t.getInt32(e+8,!r);for(s=[],p=0;p<l;p++)s[p]=t.getInt32(d+4*p,!r);return s;case 10:if(1===l)return t.getInt32(d,!r)/t.getInt32(d+4,!r);for(s=[],p=0;p<l;p++)s[p]=t.getInt32(d+8*p,!r)/t.getInt32(d+4+8*p,!r);return s}},t.prototype.getStringFromDB=function(t,e,i){for(var o="",r=e;r<e+i;r++)o+=String.fromCharCode(t.getUint8(r));return o},t.prototype.readEXIFData=function(t,e){if("Exif"!==this.getStringFromDB(t,e,4))return this.log("Not valid EXIF data! "+this.getStringFromDB(t,e,4)),!1;var i,o,r,n,s,a=e+6;if(18761===t.getUint16(a))i=!1;else{if(19789!==t.getUint16(a))return this.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;i=!0}if(42!==t.getUint16(a+2,!i))return this.log("Not valid TIFF data! (no 0x002A)"),!1;var h=t.getUint32(a+4,!i);if(h<8)return this.log("Not valid TIFF data! (First offset less than 8)",t.getUint32(a+4,!i)),!1;if((o=this.readTags(t,a,a+h,this.TiffTags,i)).ExifIFDPointer)for(r in n=this.readTags(t,a,a+o.ExifIFDPointer,this.Tags,i))if({}.hasOwnProperty.call(n,r)){switch(r){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":n[r]=this.StringValues[r][n[r]];break;case"ExifVersion":case"FlashpixVersion":n[r]=String.fromCharCode(n[r][0],n[r][1],n[r][2],n[r][3]);break;case"ComponentsConfiguration":n[r]=this.StringValues.Components[n[r][0]]+this.StringValues.Components[n[r][1]]+this.StringValues.Components[n[r][2]]+this.StringValues.Components[n[r][3]]}o[r]=n[r]}if(o.GPSInfoIFDPointer)for(r in s=this.readTags(t,a,a+o.GPSInfoIFDPointer,this.GPSTags,i))if({}.hasOwnProperty.call(s,r)){switch(r){case"GPSVersionID":s[r]=s[r][0]+"."+s[r][1]+"."+s[r][2]+"."+s[r][3]}o[r]=s[r]}return o},t.prototype.checkImageType=function(t){return t instanceof Image||t instanceof HTMLImageElement},t.prototype.getData=function(t,e){return!(this.checkImageType(t)&&!t.complete)&&(this.imageHasData(t)?e&&e.call(t):this.getImageData(t,e),!0)},t.prototype.getTag=function(t,e){if(this.imageHasData(t))return t.exifdata[e]},t.prototype.getAllTags=function(t){if(!this.imageHasData(t))return{};var e,i=t.exifdata,o={};for(e in i)i.hasOwnProperty(e)&&(o[e]=i[e]);return o},t.prototype.pretty=function(t){if(!this.imageHasData(t))return"";var e,i=t.exifdata,o="";for(e in i)i.hasOwnProperty(e)&&("object"==typeof i[e]?i[e]instanceof Number?o+=e+" : "+i[e]+" ["+i[e].numerator+"/"+i[e].denominator+"]\r\n":o+=e+" : ["+i[e].length+" values]\r\n":o+=e+" : "+i[e]+"\r\n");return o},t.prototype.readFromBinaryFile=function(t){return this.findEXIFinJPEG(t)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&console.log(t)},t}(),c=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"next",{get:function(){return this.myNext},set:function(t){this.myNext=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"prev",{get:function(){return this.myPrev},set:function(t){this.myPrev=t},enumerable:!0,configurable:!0}),t}(),g=function(){function t(t){void 0===t&&(t=1);for(var e=this.firstAvailable=new c,i=1;i<t;i++){var o=new c;e.next=o,e=o}}return Object.defineProperty(t.prototype,"instance",{get:function(){return this},enumerable:!0,configurable:!0}),t.prototype.borrow=function(t,e){if(null==this.firstAvailable)throw new Error("Pool exhausted");this.borrowed++;var i=this.firstAvailable;return this.firstAvailable=i.next,i.x=t,i.y=e,i},t.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.next=this.firstAvailable,this.firstAvailable=t},t}(),u=function(){function t(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0),this.left=t,this.right=t+i,this.top=e,this.bottom=e+o}return Object.defineProperty(t.prototype,"width",{get:function(){return this.right-this.left},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.bottom-this.top},enumerable:!0,configurable:!0}),t.prototype.getCentre=function(){var t=this.width,e=this.height;return(new g).instance.borrow(this.left+t/2,this.top+e/2)},t}(),l=function(){function t(t,e,i,o){this.cropperSettings=new a,this.over=!1,this.drag=!1,this._position=new c(t,e),this.offset=new c(0,0),this.radius=i,this.cropperSettings=o}return t.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},t.prototype.draw=function(t){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,e){return t>this.position.x-this.radius+this.offset.x&&t<this.position.x+this.radius+this.offset.x&&e>this.position.y-this.radius+this.offset.y&&e<this.position.y+this.radius+this.offset.y},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},enumerable:!0,configurable:!0}),t.prototype.setPosition=function(t,e){this._position.x=t,this._position.y=e},t}(),d=function(t){function e(e,i,o,r){return t.call(this,e,i,o,r)||this}return r(e,t),e.prototype.drawCornerBorder=function(t){var e=10;(this.over||this.drag)&&(e=12);var i=this.cropperSettings.markerSizeMultiplier,o=this.cropperSettings.markerSizeMultiplier;this.horizontalNeighbour.position.x<this.position.x&&(i=-this.cropperSettings.markerSizeMultiplier),this.verticalNeighbour.position.y<this.position.y&&(o=-this.cropperSettings.markerSizeMultiplier),t.beginPath(),this.cropperSettings.cropperDrawSettings.lineDash&&t.setLineDash([1,3]),t.lineJoin="miter",t.moveTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.closePath(),t.lineWidth=this.cropperSettings.cropperDrawSettings.strokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.strokeColor||"rgba(255,255,255,.7)",t.stroke()},e.prototype.drawCornerFill=function(t){var e=10;(this.over||this.drag)&&(e=12);var i=this.cropperSettings.markerSizeMultiplier,o=this.cropperSettings.markerSizeMultiplier;if(this.horizontalNeighbour.position.x<this.position.x&&(i=-this.cropperSettings.markerSizeMultiplier),this.verticalNeighbour.position.y<this.position.y&&(o=-this.cropperSettings.markerSizeMultiplier),this.cropperSettings.rounded){var r=this.position.x-this.horizontalNeighbour.position.x,n=this.position.y-this.verticalNeighbour.position.y,s=Math.round(Math.sin(Math.PI/2)*Math.abs(r/2))/4,a=Math.round(Math.sin(Math.PI/2)*Math.abs(n/2))/4;this.offset.x=i>0?s:-s,this.offset.y=o>0?a:-a}else this.offset.x=0,this.offset.y=0;t.beginPath(),this.cropperSettings.cropperDrawSettings.lineDash&&t.setLineDash([1,3]),t.moveTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.closePath(),t.fillStyle=this.cropperSettings.cropperDrawSettings.fillColor||"rgba(255,255,255,.7)",t.fill()},e.prototype.moveX=function(t){this.setPosition(t,this.position.y)},e.prototype.moveY=function(t){this.setPosition(this.position.x,t)},e.prototype.move=function(t,e){this.setPosition(t,e),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(e)},e.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},e.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},e.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},e.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},e.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},e}(l),f=function(){return function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.id=i,this.x=t,this.y=e}}(),m=function(t){function e(e,i,o,r){var n=t.call(this,e,i,o,r)||this;return n.iconPoints=[],n.scaledIconPoints=[],n.getDragIconPoints(n.iconPoints,1),n.getDragIconPoints(n.scaledIconPoints,1.2),n}return r(e,t),e.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},e.prototype.getDragIconPoints=function(t,e){var i=17*e,o=14*e,r=8*e,n=4*e;t.push((new g).instance.borrow(-n/2,i-r)),t.push((new g).instance.borrow(-o/2,i-r)),t.push((new g).instance.borrow(0,i)),t.push((new g).instance.borrow(o/2,i-r)),t.push((new g).instance.borrow(n/2,i-r)),t.push((new g).instance.borrow(n/2,n/2)),t.push((new g).instance.borrow(i-r,n/2)),t.push((new g).instance.borrow(i-r,o/2)),t.push((new g).instance.borrow(i,0)),t.push((new g).instance.borrow(i-r,-o/2)),t.push((new g).instance.borrow(i-r,-n/2)),t.push((new g).instance.borrow(n/2,-n/2)),t.push((new g).instance.borrow(n/2,-i+r)),t.push((new g).instance.borrow(o/2,-i+r)),t.push((new g).instance.borrow(0,-i)),t.push((new g).instance.borrow(-o/2,-i+r)),t.push((new g).instance.borrow(-n/2,-i+r)),t.push((new g).instance.borrow(-n/2,-n/2)),t.push((new g).instance.borrow(-i+r,-n/2)),t.push((new g).instance.borrow(-i+r,-o/2)),t.push((new g).instance.borrow(-i,0)),t.push((new g).instance.borrow(-i+r,o/2)),t.push((new g).instance.borrow(-i+r,n/2)),t.push((new g).instance.borrow(-n/2,n/2))},e.prototype.drawIcon=function(t,e){var i,o;if(this.cropperSettings.showCenterMarker){t.beginPath(),t.moveTo(e[0].x+this.position.x,e[0].y+this.position.y);try{for(var r=n(e),s=r.next();!s.done;s=r.next()){var a=s.value;t.lineTo(a.x+this.position.x,a.y+this.position.y)}}catch(h){i={error:h}}finally{try{s&&!s.done&&(o=r["return"])&&o.call(r)}finally{if(i)throw i.error}}t.closePath(),t.fillStyle=this.cropperSettings.cropperDrawSettings.dragIconFillColor,t.fill(),t.lineWidth=this.cropperSettings.cropperDrawSettings.dragIconStrokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.dragIconStrokeColor,t.stroke()}},e.prototype.recalculatePosition=function(t){var e=t.getCentre();this.setPosition(e.x,e.y),(new g).instance.returnPoint(e)},e}(l),v=function(){return function(){}}(),y=function(){function t(){this.share={}}return t.prototype.setPressed=function(t){this.pressed=t},t.prototype.setReleased=function(t){this.pressed},t.prototype.setOver=function(t){this.over=t},t.prototype.setStyle=function(t,e){this.pressed!==undefined?this.pressed:this.over},t}(),w=function(t){function e(e){var i=t.call(this)||this;i.imageCropperDataShare=new y;var o=e.width,r=e.height,n=e.keepAspect,s=e.touchRadius,a=e.centerTouchRadius,h=e.minWidth,p=e.minHeight,c=e.croppedWidth,u=e.croppedHeight;return i.cropperSettings=e,i.crop=i,i.x=0,i.y=0,i.canvasHeight=e.canvasHeight,i.canvasWidth=e.canvasWidth,i.width=o,void 0===o&&(i.width=100),i.height=r,void 0===r&&(i.height=50),i.keepAspect=n,void 0===n&&(i.keepAspect=!0),i.touchRadius=s,void 0===s&&(i.touchRadius=20),i.minWidth=h,i.minHeight=p,i.aspectRatio=0,i.currentDragTouches=[],i.isMouseDown=!1,i.ratioW=1,i.ratioH=1,i.fileType=e.fileType,i.imageSet=!1,i.pointPool=new g(200),i.tl=new d(0,0,s,i.cropperSettings),i.tr=new d(0+o,0,s,i.cropperSettings),i.bl=new d(0,0+r,s,i.cropperSettings),i.br=new d(0+o,0+r,s,i.cropperSettings),i.tl.addHorizontalNeighbour(i.tr),i.tl.addVerticalNeighbour(i.bl),i.tr.addHorizontalNeighbour(i.tl),i.tr.addVerticalNeighbour(i.br),i.bl.addHorizontalNeighbour(i.br),i.bl.addVerticalNeighbour(i.tl),i.br.addHorizontalNeighbour(i.bl),i.br.addVerticalNeighbour(i.tr),i.markers=[i.tl,i.tr,i.bl,i.br],i.center=new m(0+o/2,0+r/2,a,i.cropperSettings),i.aspectRatio=r/o,i.croppedImage=new Image,i.currentlyInteracting=!1,i.cropWidth=c,i.cropHeight=u,i}return r(e,t),e.prototype.sign=function(t){return+t===t?0===t?t:t>0?1:-1:NaN},e.prototype.getMousePos=function(t,e){var i=t.getBoundingClientRect();return(new g).instance.borrow(e.clientX-i.left,e.clientY-i.top)},e.prototype.getTouchPos=function(t,e){var i=t.getBoundingClientRect();return(new g).instance.borrow(e.clientX-i.left,e.clientY-i.top)},e.prototype.detectVerticalSquash=function(t){var e=t.height,i=document.createElement("canvas");i.width=1,i.height=e;var o=i.getContext("2d");o.drawImage(t,0,0);var r=o.getImageData(0,0,1,e);if(r){for(var n=r.data,s=0,a=e,h=e;h>s;){0===n[4*(h-1)+3]?a=h:s=h,h=a+s>>1}var p=h/e;return 0===p?1:p}return 1},e.prototype.getDataUriMimeType=function(t){var e=t.substring(0,50),i="image/png",o=RegExp(/^(data:)([\w\/\+]+);(charset=[\w-]+|base64).*,(.*)/gi).exec(e);return o&&o[2]&&"image/jpg"===(i=o[2])&&(i="image/jpeg"),i},e.prototype.prepare=function(t){this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas");var e=t.parentElement?t.parentElement.clientWidth:0;e>0&&this.cropperSettings.dynamicSizing?(this.cropCanvas.width=e,this.buffer.width=e,t.width=e):(this.cropCanvas.width=this.cropWidth,this.buffer.width=t.width),this.cropCanvas.height=this.cropHeight,this.buffer.height=t.height,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.draw(this.ctx)},e.prototype.updateSettings=function(t){this.cropperSettings=t},e.prototype.resizeCanvas=function(t,e,i){void 0===i&&(i=!1),this.canvas.width=this.cropCanvas.width=this.width=this.canvasWidth=this.buffer.width=t,this.canvas.height=this.cropCanvas.height=this.height=this.canvasHeight=this.buffer.height=e,i&&this.setImage(this.srcImage)},e.prototype.reset=function(){this.setImage(undefined)},e.prototype.draw=function(t){var e=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var i=this.srcImage.height/this.srcImage.width,o=this.canvasHeight/this.canvasWidth,r=this.canvasWidth,n=this.canvasHeight;o>i?(r=this.canvasWidth,n=this.canvasWidth*i):(n=this.canvasHeight,r=this.canvasHeight/i),this.ratioW=r/this.srcImage.width,this.ratioH=n/this.srcImage.height,o<i?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-r/2,0,r,n):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-n/2,r,n),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),t.lineWidth=this.cropperSettings.cropperDrawSettings.strokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.strokeColor,t.fillStyle=this.cropperSettings.cropperDrawSettings.backgroundFillColor,this.cropperSettings.rounded?(t.fillRect(0,0,this.canvas.width,this.canvas.height),t.save(),t.beginPath(),t.arc(e.left+e.width/2,e.top+e.height/2,e.width/2,0,2*Math.PI),t.stroke(),t.clip(),o<i?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-r/2,0,r,n):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-n/2,r,n),t.restore()):(t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.drawImage(this.buffer,e.left,e.top,Math.max(e.width,1),Math.max(e.height,1),e.left,e.top,e.width,e.height),t.strokeRect(e.left,e.top,e.width,e.height));for(var s=0;s<this.markers.length;s++)this.markers[s].draw(t);this.center.draw(t)}else t.fillStyle="rgba(192,192,192,1)",t.fillRect(0,0,this.canvas.width,this.canvas.height)},e.prototype.dragCenter=function(t,e,i){var o=this.getBounds(),r=t-o.width/2,n=t+o.width/2,s=e-o.height/2,a=e+o.height/2;n>=this.maxXClamp&&(t=this.maxXClamp-o.width/2),r<=this.minXClamp&&(t=o.width/2+this.minXClamp),s<this.minYClamp&&(e=o.height/2+this.minYClamp),a>=this.maxYClamp&&(e=this.maxYClamp-o.height/2),this.tl.moveX(t-o.width/2),this.tl.moveY(e-o.height/2),this.tr.moveX(t+o.width/2),this.tr.moveY(e-o.height/2),this.bl.moveX(t-o.width/2),this.bl.moveY(e+o.height/2),this.br.moveX(t+o.width/2),this.br.moveY(e+o.height/2),i.setPosition(t,e)},e.prototype.enforceMinSize=function(t,e,i){var o=t-i.getHorizontalNeighbour().position.x,r=e-i.getVerticalNeighbour().position.y,n=this.minWidth-Math.abs(o),s=this.minHeight-Math.abs(r);return 0===o||0===r?(t=i.position.x,e=i.position.y,(new g).instance.borrow(t,e)):(this.keepAspect?n>0&&s/this.aspectRatio>0?n>s/this.aspectRatio?o<0?(t-=n,r<0?e-=n*this.aspectRatio:e+=n*this.aspectRatio):(t+=n,r<0?e-=n*this.aspectRatio:e+=n*this.aspectRatio):r<0?(e-=s,o<0?t-=s/this.aspectRatio:t+=s/this.aspectRatio):(e+=s,o<0?t-=s/this.aspectRatio:t+=s/this.aspectRatio):n>0?o<0?(t-=n,r<0?e-=n*this.aspectRatio:e+=n*this.aspectRatio):(t+=n,r<0?e-=n*this.aspectRatio:e+=n*this.aspectRatio):s>0&&(r<0?(e-=s,o<0?t-=s/this.aspectRatio:t+=s/this.aspectRatio):(e+=s,o<0?t-=s/this.aspectRatio:t+=s/this.aspectRatio)):(n>0&&(o<0?t-=n:t+=n),s>0&&(r<0?e-=s:e+=s)),(t<this.minXClamp||t>this.maxXClamp||e<this.minYClamp||e>this.maxYClamp)&&(t=i.position.x,e=i.position.y),(new g).instance.borrow(t,e))},e.prototype.dragCorner=function(t,e,i){var o,r=0,n=0,s=0,a=0,h=0,p=0,c=0,u=0,l=0;if(this.keepAspect){if(s=(o=i.getHorizontalNeighbour().getVerticalNeighbour()).position.x,a=o.position.y,t<=o.position.x){if(e<=o.position.y){if(r=s-100/this.aspectRatio,n=a-100/this.aspectRatio*this.aspectRatio,(l=this.getSide((new g).instance.borrow(r,n),o.position,(new g).instance.borrow(t,e)))>0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y-h,u=o.position.x-p;var d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}else if(l<0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y-h,u=o.position.x-p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}}else if(r=s-100/this.aspectRatio,n=a+100/this.aspectRatio*this.aspectRatio,(l=this.getSide((new g).instance.borrow(r,n),o.position,(new g).instance.borrow(t,e)))>0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y+h,u=o.position.x-p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}else if(l<0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y+h,u=o.position.x-p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}}else if(e<=o.position.y){if(r=s+100/this.aspectRatio,n=a-100/this.aspectRatio*this.aspectRatio,(l=this.getSide((new g).instance.borrow(r,n),o.position,(new g).instance.borrow(t,e)))<0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y-h,u=o.position.x+p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}else if(l>0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y-h,u=o.position.x+p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}}else if(r=s+100/this.aspectRatio,n=a+100/this.aspectRatio*this.aspectRatio,(l=this.getSide((new g).instance.borrow(r,n),o.position,(new g).instance.borrow(t,e)))<0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y+h,u=o.position.x+p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}else if(l>0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y+h,u=o.position.x+p;d=this.enforceMinSize(u,c,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}}else{d=this.enforceMinSize(t,e,i);i.move(d.x,d.y),(new g).instance.returnPoint(d)}this.center.recalculatePosition(this.getBounds())},e.prototype.getSide=function(t,e,i){var o=this.sign((e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x));return(new g).instance.returnPoint(t),(new g).instance.returnPoint(i),o},e.prototype.handleRelease=function(t){if(null!=t){for(var e=0,i=0;i<this.currentDragTouches.length;i++)t.id===this.currentDragTouches[i].id&&(this.currentDragTouches[i].dragHandle.setDrag(!1),e=i);this.currentDragTouches.splice(e,1),this.draw(this.ctx)}},e.prototype.handleMove=function(t){for(var e,i,o=!1,r=0;r<this.currentDragTouches.length;r++)if(t.id===this.currentDragTouches[r].id&&null!=this.currentDragTouches[r].dragHandle){var s=this.currentDragTouches[r],a=this.clampPosition(t.x-s.dragHandle.offset.x,t.y-s.dragHandle.offset.y);t.x=a.x,t.y=a.y,(new g).instance.returnPoint(a),s.dragHandle instanceof d?this.dragCorner(t.x,t.y,s.dragHandle):this.dragCenter(t.x,t.y,s.dragHandle),this.currentlyInteracting=!0,o=!0,this.imageCropperDataShare.setPressed(this.canvas);break}if(!o){try{for(var h=n(this.markers),p=h.next();!p.done;p=h.next()){var c=p.value;if(c.touchInBounds(t.x,t.y)){t.dragHandle=c,this.currentDragTouches.push(t),c.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.position.x,t.dragHandle.offset.y=t.y-t.dragHandle.position.y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}}catch(u){e={error:u}}finally{try{p&&!p.done&&(i=h["return"])&&i.call(h)}finally{if(e)throw e.error}}null!==t.dragHandle&&"undefined"!=typeof t.dragHandle||this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.position.x,t.dragHandle.offset.y=t.y-t.dragHandle.position.y,this.dragCenter(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},e.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,e=this.canvas.height/this.canvas.width,i=this.canvas.width,o=this.canvas.height;e>t?(i=this.canvas.width,o=this.canvas.width*t):(o=this.canvas.height,i=this.canvas.height/t),this.minXClamp=this.canvas.width/2-i/2,this.minYClamp=this.canvas.height/2-o/2,this.maxXClamp=this.canvas.width/2+i/2,this.maxYClamp=this.canvas.height/2+o/2},e.prototype.getCropBounds=function(){var t=this.getBounds();return t.top=Math.round((t.top-this.minYClamp)/this.ratioH),t.bottom=Math.round((t.bottom-this.minYClamp)/this.ratioH),t.left=Math.round((t.left-this.minXClamp)/this.ratioW),t.right=Math.round((t.right-this.minXClamp)/this.ratioW),t},e.prototype.clampPosition=function(t,e){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),e<this.minYClamp&&(e=this.minYClamp),e>this.maxYClamp&&(e=this.maxYClamp),(new g).instance.borrow(t,e)},e.prototype.isImageSet=function(){return this.imageSet},e.prototype.setImage=function(t){if(this.srcImage=t,t){this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.buffer.getContext("2d").clearRect(0,0,this.buffer.width,this.buffer.height),this.cropperSettings.fileType||(this.fileType=this.getDataUriMimeType(t.src)),this.cropperSettings.minWithRelativeToResolution&&(this.minWidth=this.canvas.width*this.cropperSettings.minWidth/this.srcImage.width,this.minHeight=this.canvas.height*this.cropperSettings.minHeight/this.srcImage.height),this.updateClampBounds(),this.canvasWidth=this.canvas.width,this.canvasHeight=this.canvas.height;var e=this.getCropPositionFromMarkers();this.setCropPosition(e)}else this.imageSet=!1,this.draw(this.ctx)},e.prototype.updateCropPosition=function(t){var e=this.getCropPositionFromBounds(t);this.setCropPosition(e)},e.prototype.setCropPosition=function(t){var e,i;this.tl.setPosition(t[0].x,t[0].y),this.tr.setPosition(t[1].x,t[1].y),this.bl.setPosition(t[2].x,t[2].y),this.br.setPosition(t[3].x,t[3].y),this.center.setPosition(t[4].x,t[4].y);try{for(var o=n(t),r=o.next();!r.done;r=o.next()){var s=r.value;(new g).instance.returnPoint(s)}}catch(a){e={error:a}}finally{try{r&&!r.done&&(i=o["return"])&&i.call(o)}finally{if(e)throw e.error}}this.vertSquashRatio=this.detectVerticalSquash(this.srcImage),this.draw(this.ctx),this.croppedImage=this.getCroppedImageHelper(!1,this.cropWidth,this.cropHeight)},e.prototype.getCropPositionFromMarkers=function(){var t,e,i,o,r=this.canvas.width,n=this.canvas.height,s=this.srcImage.height/this.srcImage.width,a=this.getBounds(),h=a.height/a.width,p=this.canvas.width/2,c=this.canvas.height/2;if(h>s){var u=Math.min(r*s,n),l=u/h;t=(new g).instance.borrow(p-l/2,c+u/2),e=(new g).instance.borrow(p+l/2,c+u/2),i=(new g).instance.borrow(p-l/2,c-u/2),o=(new g).instance.borrow(p+l/2,c-u/2)}else{var d=Math.min(n/s,r),f=d*h;t=(new g).instance.borrow(p-d/2,c+f/2),e=(new g).instance.borrow(p+d/2,c+f/2),i=(new g).instance.borrow(p-d/2,c-f/2),o=(new g).instance.borrow(p+d/2,c-f/2)}return[t,e,i,o,(new g).instance.borrow(p,c)]},e.prototype.getCropPositionFromBounds=function(t){var e=0,i=0,o=this.canvasHeight/this.canvasWidth,r=this.srcImage.height/this.srcImage.width;o>r?e=this.buffer.height/2-this.canvasWidth*r/2:i=this.buffer.width/2-this.canvasHeight/r/2;var n=(this.canvasWidth-2*i)/this.srcImage.width,s=(this.canvasHeight-2*e)/this.srcImage.height,a=t.height*s,h=t.width*n,p=t.left*n+i,c=t.top*s+e;if(this.keepAspect){var u=a/this.aspectRatio,l=h*this.aspectRatio;this.getCropBounds().height===t.height?a=l:this.getCropBounds().width===t.width?h=u:Math.abs(l-a)<Math.abs(u-h)?h=u:a=l}return[(new g).instance.borrow(p,c+a),(new g).instance.borrow(p+h,c+a),(new g).instance.borrow(p,c),(new g).instance.borrow(p+h,c),(new g).instance.borrow(p+h/2,c+a/2)]},e.prototype.getCroppedImageHelper=function(t,e,i){return this.cropperSettings.cropOnResize?this.getCroppedImage(t,e,i):this.croppedImage?this.croppedImage:document.createElement("img")},e.prototype.getCroppedImage=function(t,e,i){var o=this.getBounds();if(this.srcImage){var r=this.srcImage.height/this.srcImage.width,n=this.canvas.height/this.canvas.width,s=this.canvas.width,a=this.canvas.height;n>r?(s=this.canvas.width,a=this.canvas.width*r):n<r?(a=this.canvas.height,s=this.canvas.height/r):(a=this.canvas.height,s=this.canvas.width),this.ratioW=s/this.srcImage.width,this.ratioH=a/this.srcImage.height;var h=(this.buffer.height-a)/2/this.ratioH,p=(this.buffer.width-s)/2/this.ratioW,c=this.cropCanvas.getContext("2d");if(this.cropperSettings.preserveSize||t){var g=Math.round(o.right/this.ratioW-o.left/this.ratioW),u=Math.round(o.bottom/this.ratioH-o.top/this.ratioH);this.cropCanvas.width=g,this.cropCanvas.height=u,this.cropperSettings.croppedWidth=this.cropCanvas.width,this.cropperSettings.croppedHeight=this.cropCanvas.height}else this.cropCanvas.width=this.cropWidth,this.cropCanvas.height=this.cropHeight;return c.clearRect(0,0,this.cropCanvas.width,this.cropCanvas.height),this.drawImageIOSFix(c,this.srcImage,Math.max(Math.round(o.left/this.ratioW-p),0),Math.max(Math.round(o.top/this.ratioH-h),0),Math.max(Math.round(o.width/this.ratioW),1),Math.max(Math.round(o.height/this.ratioH),1),0,0,this.cropCanvas.width,this.cropCanvas.height),this.cropperSettings.resampleFn&&this.cropperSettings.resampleFn(this.cropCanvas),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height,this.croppedImage.src=this.cropCanvas.toDataURL(this.fileType,this.cropperSettings.compressRatio),this.croppedImage}return document.createElement("img")},e.prototype.getBounds=function(){var t,e,i=Number.MAX_VALUE,o=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=-Number.MAX_VALUE;try{for(var a=n(this.markers),h=a.next();!h.done;h=a.next()){var p=h.value;p.position.x<i&&(i=p.position.x),p.position.x>r&&(r=p.position.x),p.position.y<o&&(o=p.position.y),p.position.y>s&&(s=p.position.y)}}catch(g){t={error:g}}finally{try{h&&!h.done&&(e=a["return"])&&e.call(a)}finally{if(t)throw t.error}}var c=new u;return c.left=i,c.right=r,c.top=o,c.bottom=s,c},e.prototype.setBounds=function(t){var e,i,o=this.getBounds();try{for(var r=n(this.markers),s=r.next();!s.done;s=r.next()){var a=s.value;a.position.x===o.left?a.position.y===o.top?a.setPosition(t.left,t.top):a.setPosition(t.left,t.bottom):a.position.y===o.top?a.setPosition(t.right,t.top):a.setPosition(t.right,t.bottom)}}catch(h){e={error:h}}finally{try{s&&!s.done&&(i=r["return"])&&i.call(r)}finally{if(e)throw e.error}}this.center.recalculatePosition(t),this.center.draw(this.ctx),this.draw(this.ctx)},e.prototype.onTouchMove=function(t){if(this.crop.isImageSet()){if(1===t.touches.length){if(this.isMouseDown){t.preventDefault();for(var e=0;e<t.touches.length;e++){var i=t.touches[e],o=this.getTouchPos(this.canvas,i),r=new f(o.x,o.y,i.identifier);(new g).instance.returnPoint(o),this.move(r)}}}else if(2===t.touches.length){t.preventDefault();var n=(t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[0].clientY-t.touches[1].clientY)*(t.touches[0].clientY-t.touches[1].clientY);if(this.previousDistance&&this.previousDistance!==n){var s=this.getBounds();n<this.previousDistance&&(s.top+=1,s.left+=1,s.right-=1,s.bottom-=1),n>this.previousDistance&&(s.top!==this.minYClamp&&s.bottom!==this.maxYClamp&&s.left!==this.minXClamp&&s.right!==this.maxXClamp?(s.top-=1,s.left-=1,s.right+=1,s.bottom+=1):s.top!==this.minYClamp&&s.bottom!==this.maxYClamp&&s.left===this.minXClamp&&s.right!==this.maxXClamp?(s.top-=1,s.right+=2,s.bottom+=1):s.top!==this.minYClamp&&s.bottom!==this.maxYClamp&&s.left!==this.minXClamp&&s.right===this.maxXClamp?(s.top-=1,s.left-=2,s.bottom+=1):s.top===this.minYClamp&&s.bottom!==this.maxYClamp&&s.left!==this.minXClamp&&s.right!==this.maxXClamp?(s.left-=1,s.right+=1,s.bottom+=2):s.top!==this.minYClamp&&s.bottom===this.maxYClamp&&s.left!==this.minXClamp&&s.right!==this.maxXClamp?(s.top-=2,s.left-=1,s.right+=1):s.top===this.minYClamp&&s.bottom!==this.maxYClamp&&s.left===this.minXClamp&&s.right!==this.maxXClamp?(s.right+=2,s.bottom+=2):s.top===this.minYClamp&&s.bottom!==this.maxYClamp&&s.left!==this.minXClamp&&s.right===this.maxXClamp?(s.left-=2,s.bottom+=2):s.top!==this.minYClamp&&s.bottom===this.maxYClamp&&s.left===this.minXClamp&&s.right!==this.maxXClamp?(s.top-=2,s.right+=2):s.top!==this.minYClamp&&s.bottom===this.maxYClamp&&s.left!==this.minXClamp&&s.right===this.maxXClamp&&(s.top-=2,s.left-=2)),s.top<this.minYClamp&&(s.top=this.minYClamp),s.bottom>this.maxYClamp&&(s.bottom=this.maxYClamp),s.left<this.minXClamp&&(s.left=this.minXClamp),s.right>this.maxXClamp&&(s.right=this.maxXClamp),this.setBounds(s)}this.previousDistance=n}this.draw(this.ctx)}},e.prototype.onMouseMove=function(t){if(this.crop.isImageSet()&&this.isMouseDown){var e=this.getMousePos(this.canvas,t);this.move(new f(e.x,e.y,0));var i=this.getDragTouchForID(0);i?(i.x=e.x,i.y=e.y):i=new f(e.x,e.y,0),(new g).instance.returnPoint(e),this.drawCursors(i),this.draw(this.ctx)}},e.prototype.move=function(t){this.isMouseDown&&this.handleMove(t)},e.prototype.getDragTouchForID=function(t){for(var e=0;e<this.currentDragTouches.length;e++)if(t===this.currentDragTouches[e].id)return this.currentDragTouches[e];return undefined},e.prototype.drawCursors=function(t){var e=!1;null!=t&&(t.dragHandle===this.center&&(this.imageCropperDataShare.setStyle(this.canvas,"move"),e=!0),null!==t.dragHandle&&t.dragHandle instanceof d&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.position.x,t.dragHandle.position.y),e=!0));var i=!1;if(!e){for(var o=0;o<this.markers.length;o++)i=i||this.drawCornerCursor(this.markers[o],t.x,t.y);i||this.imageCropperDataShare.setStyle(this.canvas,"initial")}i||e||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"move"))},e.prototype.drawCornerCursor=function(t,e,i){return t.touchInBounds(e,i)?(t.setOver(!0),t.getHorizontalNeighbour().position.x>t.position.x?t.getVerticalNeighbour().position.y>t.position.y?(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nwse-resize")):(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nesw-resize")):t.getVerticalNeighbour().position.y>t.position.y?(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nesw-resize")):(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nwse-resize")),!0):(t.setOver(!1),!1)},e.prototype.onTouchStart=function(t){var e,i;if(this.crop.isImageSet()){var o=t.touches[0],r=this.getTouchPos(this.canvas,o),s=new f(r.x,r.y,o.identifier);(new g).instance.returnPoint(r),this.isMouseDown=!1;try{for(var a=n(this.markers),h=a.next();!h.done;h=a.next()){h.value.touchInBounds(s.x,s.y)&&(this.isMouseDown=!0)}}catch(p){e={error:p}}finally{try{h&&!h.done&&(i=a["return"])&&i.call(a)}finally{if(e)throw e.error}}this.center.touchInBounds(s.x,s.y)&&(this.isMouseDown=!0)}},e.prototype.onTouchEnd=function(t){if(this.crop.isImageSet()){for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e],o=this.getDragTouchForID(i.identifier);o&&o!==undefined&&((o.dragHandle instanceof d||o.dragHandle instanceof m)&&o.dragHandle.setOver(!1),this.handleRelease(o))}0===this.currentDragTouches.length&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},e.prototype.drawImageIOSFix=function(t,e,i,o,r,n,s,a,h,p){t.drawImage(e,i,o,r,n,s,a,h,p)},e.prototype.onMouseDown=function(t){this.crop.isImageSet()&&(this.isMouseDown=!0)},e.prototype.onMouseUp=function(t){this.crop.isImageSet()&&(this.imageCropperDataShare.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new f(0,0,0)))},e}(v),C=function(){function t(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0),this.x=+t,this.y=+e,this.w=+i,this.h=+o}return t.prototype.toBounds=function(){return new u(this.x,this.y,this.w,this.h)},t.prototype.isInitialized=function(){return 0!==this.x&&0!==this.y&&0!==this.w&&0!==this.h},t}(),b=function(){function t(t){this.cropPositionChange=new e.EventEmitter,this.exif=new p,this.onCrop=new e.EventEmitter,this.imageSet=new e.EventEmitter,this.renderer=t}return t.prototype.ngAfterViewInit=function(){var t=this.cropcanvas.nativeElement;this.settings||(this.settings=new a),this.settings.cropperClass&&this.renderer.setAttribute(t,"class",this.settings.cropperClass),this.settings.dynamicSizing?(this.windowListener=this.resize.bind(this),window.addEventListener("resize",this.windowListener)):(this.renderer.setAttribute(t,"width",this.settings.canvasWidth.toString()),this.renderer.setAttribute(t,"height",this.settings.canvasHeight.toString())),this.cropper||(this.cropper=new w(this.settings)),this.cropper.prepare(t)},t.prototype.ngOnChanges=function(t){if(this.isCropPositionChanged(t)){if(this.cropper.updateCropPosition(this.cropPosition.toBounds()),this.cropper.isImageSet()){var e=this.cropper.getCropBounds();this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(e)}this.updateCropBounds()}t.inputImage&&this.setImage(t.inputImage.currentValue),t.settings&&this.cropper&&(this.cropper.updateSettings(this.settings),this.cropper.isImageSet()&&(this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds())))},t.prototype.ngOnDestroy=function(){this.settings.dynamicSizing&&this.windowListener&&window.removeEventListener("resize",this.windowListener)},t.prototype.onTouchMove=function(t){this.cropper.onTouchMove(t)},t.prototype.onTouchStart=function(t){this.cropper.onTouchStart(t)},t.prototype.onTouchEnd=function(t){this.cropper.onTouchEnd(t),this.cropper.isImageSet()&&(this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds()),this.updateCropBounds())},t.prototype.onMouseDown=function(t){this.cropper.onMouseDown(t)},t.prototype.onMouseUp=function(t){this.cropper.isImageSet()&&(this.cropper.onMouseUp(t),this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds()),this.updateCropBounds())},t.prototype.onMouseMove=function(t){this.cropper.onMouseMove(t)},t.prototype.fileChangeListener=function(t){var e=this;if(0!==t.target.files.length){var i=t.target.files[0];if(this.settings.allowedFilesRegex.test(i.name)){var o=new Image,r=new FileReader;r.addEventListener("loadend",function(t){o.addEventListener("load",function(){e.setImage(o)}),o.src=t.target.result}),r.readAsDataURL(i)}}},t.prototype.resize=function(){var t=this.cropcanvas.nativeElement;this.settings.canvasWidth=t.offsetWidth,this.settings.canvasHeight=t.offsetHeight,this.cropper.resizeCanvas(t.offsetWidth,t.offsetHeight,!0)},t.prototype.reset=function(){this.cropper.reset(),this.renderer.setAttribute(this.cropcanvas.nativeElement,"class",this.settings.cropperClass),this.image.image=this.cropper.getCroppedImageHelper().src},t.prototype.setImage=function(t,e){var i=this;void 0===e&&(e=null),this.imageSet.emit(!0),this.renderer.setAttribute(this.cropcanvas.nativeElement,"class",this.settings.cropperClass+" "+this.settings.croppingClass),this.raf=window.requestAnimationFrame(function(){i.raf&&window.cancelAnimationFrame(i.raf),t.naturalHeight>0&&t.naturalWidth>0&&(t.height=t.naturalHeight,t.width=t.naturalWidth,window.cancelAnimationFrame(i.raf),i.getOrientedImage(t,function(o){if(i.settings.dynamicSizing){var r=i.cropcanvas.nativeElement;i.settings.canvasWidth=r.offsetWidth,i.settings.canvasHeight=r.offsetHeight,i.cropper.resizeCanvas(r.offsetWidth,r.offsetHeight,!1)}i.cropper.setImage(o),i.cropPosition&&i.cropPosition.isInitialized()&&i.cropper.updateCropPosition(i.cropPosition.toBounds()),i.image.original=o;var n=i.cropper.getCropBounds();i.image.image=i.cropper.getCroppedImageHelper().src,i.image||(i.image=t),null!=e&&(n=e,i.cropper.setBounds(n),i.cropper.updateCropPosition(n)),i.onCrop.emit(n)}))})},t.prototype.isCropPositionChanged=function(t){return!!(this.cropper&&t.cropPosition&&this.isCropPositionUpdateNeeded)||(this.isCropPositionUpdateNeeded=!0,!1)},t.prototype.updateCropBounds=function(){var t=this.cropper.getCropBounds();this.cropPositionChange.emit(new C(t.left,t.top,t.width,t.height)),this.isCropPositionUpdateNeeded=!1},t.prototype.getOrientedImage=function(t,e){var i,o=this;this.exif.getData(t,function(){var r=o.exif.getTag(t,"Orientation");if([3,6,8].indexOf(r)>-1){var n=document.createElement("canvas"),s=n.getContext("2d"),a=t.width,h=t.height,p=0,c=0,g=0;switch(r){case 3:p=-t.width,c=-t.height,g=180;break;case 6:a=t.height,h=t.width,c=-t.height,g=90;break;case 8:a=t.height,h=t.width,p=-t.width,g=270}n.width=a,n.height=h,s.rotate(g*Math.PI/180),s.drawImage(t,p,c),(i=document.createElement("img")).width=a,i.height=h,i.addEventListener("load",function(){e(i)}),i.src=n.toDataURL("image/png")}else e(i=t)})},t.decorators=[{type:e.Component,args:[{selector:"img-cropper",template:'<span class="ng2-imgcrop">\n  <input\n    *ngIf="!settings.noFileInput"\n    #fileInput\n    type="file"\n    accept="image/*"\n    (change)="fileChangeListener($event)"\n  />\n  <canvas\n    #cropcanvas\n    (mousedown)="onMouseDown($event)"\n    (mouseup)="onMouseUp($event)"\n    (mousemove)="onMouseMove($event)"\n    (mouseleave)="onMouseUp($event)"\n    (touchmove)="onTouchMove($event)"\n    (touchend)="onTouchEnd($event)"\n    (touchstart)="onTouchStart($event)"\n  >\n  </canvas>\n</span>\n'}]}],t.ctorParameters=function(){return[{type:e.Renderer2}]},t.propDecorators={cropcanvas:[{type:e.ViewChild,args:["cropcanvas",{"static":!0}]}],fileInput:[{type:e.ViewChild,args:["fileInput",{"static":!1}]}],settings:[{type:e.Input}],image:[{type:e.Input}],inputImage:[{type:e.Input}],cropper:[{type:e.Input}],cropPosition:[{type:e.Input}],cropPositionChange:[{type:e.Output}],onCrop:[{type:e.Output}],imageSet:[{type:e.Output}]},t}(),S=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{declarations:[b],exports:[b],imports:[i.CommonModule]}]}],t}(),x=function(){function t(){}return t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}(),I=function(){function t(){}return t.prototype.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t}();t.Bounds=u,t.CornerMarker=d,t.CropPosition=C,t.CropService=I,t.CropTouch=f,t.CropperDrawSettings=s,t.CropperSettings=a,t.DragMarker=m,t.Exif=p,t.Fraction=h,t.Handle=l,t.ImageCropper=w,t.ImageCropperComponent=b,t.ImageCropperDataShare=y,t.ImageCropperModel=v,t.ImageCropperModule=S,t.ImageCropperService=x,t.Point=c,t.PointPool=g,t.a=v,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-img-cropper.umd.min.js.map